#===+====1====+====2====+====3====+====4====+====5====+====6====+====7====+====8====+====9====+====0
# nginx環境構築
#===+====1====+====2====+====3====+====4====+====5====+====6====+====7====+====8====+====9====+====0
FROM nginx:mainline-alpine

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# 動作用の環境調整
# ・インストール済みパッケージ最新化
# ・ライブラリインストール
# ・www-data ユーザの作成
# ・アプリケーションルートの作成
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
RUN apk --update-cache --no-cache upgrade \
    && apk --update-cache --no-cache add tzdata \
    && adduser -D -H -u 1000 -s /bin/sh -G www-data www-data \
    && mkdir -p /var/www/html

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# 設定ファイルの配置
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
COPY ./docker/nginx/nginx.conf   /etc/nginx/
COPY ./docker/nginx/default.conf /etc/nginx/conf.d/

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# ソースコードの配置
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
COPY ./application /var/www/html

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# 動作用の各種調整
# ・権限の調整
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
RUN chown -R www-data:www-data /var/www/html

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# 停止時のシグナルをSIGTERMとする
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
STOPSIGNAL SIGTERM

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# TCP/80 ポートを外部公開
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
EXPOSE 80

#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
# nginxの実行
#---+----1----+----2----+----3----+----4----+----5----+----6----+----7----+----8----+----9----+----0
CMD ["nginx", "-g", "daemon off;"]
